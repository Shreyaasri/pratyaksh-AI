<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartAttend - Face Recognition Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 1600px; 
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 28px; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      font-size: 14px;
    }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    
    .main-content {
      padding: 30px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
    }
    
    .section {
      background: #f8fafc;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .section h2 {
      color: #1e293b;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    #videoContainer {
      position: relative;
      width: 100%;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    #webcam {
      width: 100%;
      display: block;
      border-radius: 12px;
    }
    
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
    }
    
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    #status {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      font-weight: 600;
      display: none;
    }
    
    #status.success { background: #dcfce7; color: #166534; display: block; }
    #status.error { background: #fee2e2; color: #991b1b; display: block; }
    #status.info { background: #dbeafe; color: #1e40af; display: block; }
    
    .student-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .student-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .student-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background: #e2e8f0;
    }
    
    .student-info {
      flex: 1;
    }
    
    .student-name {
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 3px;
    }
    
    .student-roll {
      font-size: 12px;
      color: #64748b;
    }
    
    .student-actions {
      display: flex;
      gap: 5px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      color: #475569;
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .recognition-result {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(16, 185, 129, 0.9);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 18px;
      animation: fadeIn 0.3s;
      z-index: 10;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .attendance-feed {
      grid-column: span 2;
    }
    
    .attendance-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .attendance-photo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .attendance-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: #dcfce7;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      color: #64748b;
      font-size: 12px;
      margin-top: 5px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active { display: flex; }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
    }
    
    .capture-preview {
      width: 100%;
      border-radius: 8px;
      margin: 15px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üéØ SmartAttend - Real-Time Face Recognition</h1>
      <div style="display: flex; gap: 15px; align-items: center;">
        <span id="modelStatus" style="font-size: 14px;">üî¥ Models Loading...</span>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="main-content">
      <!-- Camera Section -->
      <div class="section">
        <h2>üì∏ Live Camera - Face Recognition</h2>
        <div id="videoContainer">
          <video id="webcam" autoplay playsinline muted></video>
          <canvas id="overlay"></canvas>
          <div id="recognitionResult"></div>
        </div>
        
        <div class="controls">
          <button class="btn btn-primary" onclick="startCamera()">‚ñ∂Ô∏è Start Camera</button>
          <button class="btn btn-success" onclick="toggleRecognition()">
            <span id="recognitionBtnText">üéØ Start Recognition</span>
          </button>
          <button class="btn btn-warning" onclick="openRegisterModal()">‚ûï Register Student</button>
          <button class="btn btn-danger" onclick="stopCamera()">‚èπÔ∏è Stop Camera</button>
        </div>
        
        <div id="status"></div>
      </div>

      <!-- Right Sidebar -->
      <div>
        <!-- Stats -->
        <div class="section">
          <h2>üìä Today's Stats</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="presentCount">0</div>
              <div class="stat-label">Present</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalStudents">0</div>
              <div class="stat-label">Total Students</div>
            </div>
          </div>
        </div>

        <!-- Registered Students -->
        <div class="section">
          <h2>üë• Registered Students</h2>
          <div class="student-list" id="studentList">
            <p style="text-align: center; color: #64748b; padding: 20px;">
              No students registered yet. Click "Register Student" to add.
            </p>
          </div>
        </div>
      </div>

      <!-- Attendance Feed -->
      <div class="section attendance-feed">
        <h2>‚úÖ Today's Attendance Log</h2>
        <div id="attendanceLog">
          <p style="text-align: center; color: #64748b; padding: 20px;">
            No attendance marked yet today.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 20px;">Register New Student</h2>
      <form onsubmit="captureStudent(event)">
        <div class="form-group">
          <label>Student Name *</label>
          <input type="text" id="regName" required placeholder="Enter full name">
        </div>
        <div class="form-group">
          <label>Roll Number *</label>
          <input type="text" id="regRoll" required placeholder="e.g., 2024001">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="regEmail" placeholder="student@example.com">
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button type="submit" class="btn btn-success" style="flex: 1;">üì∏ Capture Face</button>
          <button type="button" class="btn btn-danger" onclick="closeRegisterModal()">Cancel</button>
        </div>
      </form>
      <canvas id="captureCanvas" class="capture-preview" style="display: none;"></canvas>
    </div>
  </div>

  <script>
    // Global variables
    let video, canvas, ctx, stream;
    let isRecognizing = false;
    let modelsLoaded = false;
    let labeledDescriptors = [];
    let faceMatcher = null;
    let studentsDatabase = [];
    let todayAttendance = new Set();

    // Initialize
    async function init() {
      video = document.getElementById('webcam');
      canvas = document.getElementById('overlay');
      ctx = canvas.getContext('2d');
      
      await loadModels();
      loadStudentsFromStorage();
      updateUI();
    }

    // Load face-api models
    async function loadModels() {
      try {
        showStatus('Loading AI models... Please wait.', 'info');
        
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
        
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        modelsLoaded = true;
        document.getElementById('modelStatus').innerHTML = 'üü¢ Models Ready';
        showStatus('AI models loaded successfully! Ready for recognition.', 'success');
        
        // Load face matcher if students exist
        if (studentsDatabase.length > 0) {
          await createFaceMatcher();
        }
      } catch (error) {
        console.error('Error loading models:', error);
        showStatus('Error loading AI models. Check console.', 'error');
      }
    }

    // Start camera
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        });
        video.srcObject = stream;
        
        video.addEventListener('loadedmetadata', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
        });
        
        showStatus('Camera started successfully!', 'success');
      } catch (error) {
        console.error('Camera error:', error);
        showStatus('Error: Please allow camera access.', 'error');
      }
    }

    // Stop camera
    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        isRecognizing = false;
        document.getElementById('recognitionBtnText').textContent = 'üéØ Start Recognition';
        showStatus('Camera stopped', 'info');
      }
    }

    // Toggle recognition
    async function toggleRecognition() {
      if (!modelsLoaded) {
        showStatus('Please wait for models to load...', 'error');
        return;
      }

      if (!video.srcObject) {
        showStatus('Please start camera first!', 'error');
        return;
      }

      if (studentsDatabase.length === 0) {
        showStatus('Please register at least one student first!', 'error');
        return;
      }

      isRecognizing = !isRecognizing;
      document.getElementById('recognitionBtnText').textContent = 
        isRecognizing ? '‚è∏Ô∏è Pause Recognition' : 'üéØ Start Recognition';

      if (isRecognizing) {
        showStatus('Real-time recognition started!', 'success');
        recognitionLoop();
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('recognitionResult').innerHTML = '';
      }
    }

    // Recognition loop
    async function recognitionLoop() {
      if (!isRecognizing) return;

      try {
        const detections = await faceapi
          .detectAllFaces(video)
          .withFaceLandmarks()
          .withFaceDescriptors();

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('recognitionResult').innerHTML = '';

        if (detections.length > 0) {
          const resizedDetections = faceapi.resizeResults(detections, {
            width: canvas.width,
            height: canvas.height
          });

          // Match each detected face
          resizedDetections.forEach(detection => {
            const box = detection.detection.box;
            
            if (faceMatcher) {
              const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
              const name = bestMatch.label;
              const distance = bestMatch.distance;
              
              // Draw box and label
              if (name !== 'unknown' && distance < 0.6) {
                // Recognized face
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
                
                ctx.fillStyle = '#10b981';
                ctx.fillRect(box.x, box.y - 30, box.width, 30);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(name, box.x + 5, box.y - 10);
                
                // Show recognition result
                document.getElementById('recognitionResult').innerHTML = 
                  `<div class="recognition-result">‚úì Recognized: ${name}</div>`;
                
                // Mark attendance automatically
                markAttendanceAuto(name);
              } else {
                // Unknown face
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 3;
                ctx.strokeRect(box.x, box.y, box.width, box.height);
                
                ctx.fillStyle = '#f59e0b';
                ctx.fillRect(box.x, box.y - 30, box.width, 30);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('Unknown', box.x + 5, box.y - 10);
              }
            }
          });
        }

        requestAnimationFrame(recognitionLoop);
      } catch (error) {
        console.error('Recognition error:', error);
      }
    }

    // Create face matcher from registered students
    async function createFaceMatcher() {
      labeledDescriptors = [];
      
      for (const student of studentsDatabase) {
        if (student.descriptors && student.descriptors.length > 0) {
          const descriptors = student.descriptors.map(d => new Float32Array(d));
          labeledDescriptors.push(
            new faceapi.LabeledFaceDescriptors(student.name, descriptors)
          );
        }
      }
      
      if (labeledDescriptors.length > 0) {
        faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
        console.log('Face matcher created with', labeledDescriptors.length, 'students');
      }
    }

    // Mark attendance automatically
    function markAttendanceAuto(studentName) {
      if (!todayAttendance.has(studentName)) {
        todayAttendance.add(studentName);
        
        const student = studentsDatabase.find(s => s.name === studentName);
        const time = new Date().toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        // Add to attendance log
        const logDiv = document.getElementById('attendanceLog');
        const itemDiv = document.createElement('div');
        itemDiv.className = 'attendance-item';
        itemDiv.innerHTML = `
          <img src="${student.photo}" class="attendance-photo" alt="${studentName}">
          <div style="flex: 1;">
            <div style="font-weight: 600;">${studentName}</div>
            <div style="font-size: 12px; color: #64748b;">${student.roll} ‚Ä¢ ${time}</div>
          </div>
          <div class="attendance-icon">‚úì</div>
        `;
        
        if (logDiv.querySelector('p')) {
          logDiv.innerHTML = '';
        }
        logDiv.insertBefore(itemDiv, logDiv.firstChild);
        
        updateStats();
        showStatus(`‚úì Attendance marked for ${studentName}`, 'success');
      }
    }

    // Open registration modal
    function openRegisterModal() {
      if (!video.srcObject) {
        showStatus('Please start camera first!', 'error');
        return;
      }
      document.getElementById('registerModal').classList.add('active');
    }

    function closeRegisterModal() {
      document.getElementById('registerModal').classList.remove('active');
      document.getElementById('captureCanvas').style.display = 'none';
    }

    // Capture student face
    async function captureStudent(e) {
      e.preventDefault();
      
      const name = document.getElementById('regName').value.trim();
      const roll = document.getElementById('regRoll').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      
      showStatus('Capturing face... Please look at camera!', 'info');
      
      try {
        // Capture multiple frames
        const descriptors = [];
        const captureCanvas = document.getElementById('captureCanvas');
        const captureCtx = captureCanvas.getContext('2d');
        
        captureCanvas.width = video.videoWidth;
        captureCanvas.height = video.videoHeight;
        
        for (let i = 0; i < 3; i++) {
          await new Promise(resolve => setTimeout(resolve, 500));
          
          const detection = await faceapi
            .detectSingleFace(video)
            .withFaceLandmarks()
            .withFaceDescriptor();
          
          if (detection) {
            descriptors.push(Array.from(detection.descriptor));
            
            if (i === 0) {
              captureCtx.drawImage(video, 0, 0);
              captureCanvas.style.display = 'block';
            }
          }
        }
        
        if (descriptors.length < 2) {
          showStatus('Could not capture face clearly. Please try again.', 'error');
          return;
        }
        
        // Save student
        const photo = captureCanvas.toDataURL('image/jpeg', 0.8);
        const student = {
          id: Date.now().toString(),
          name,
          roll,
          email,
          photo,
          descriptors,
          registeredAt: new Date().toISOString()
        };
        
        studentsDatabase.push(student);
        saveStudentsToStorage();
        await createFaceMatcher();
        
        showStatus(`‚úì ${name} registered successfully!`, 'success');
        closeRegisterModal();
        e.target.reset();
        updateUI();
        
      } catch (error) {
        console.error('Capture error:', error);
        showStatus('Error capturing face. Please try again.', 'error');
      }
    }

    // Delete student
    function deleteStudent(id) {
      if (confirm('Are you sure you want to delete this student?')) {
        studentsDatabase = studentsDatabase.filter(s => s.id !== id);
        saveStudentsToStorage();
        createFaceMatcher();
        updateUI();
        showStatus('Student deleted', 'info');
      }
    }

    // Storage functions
    function saveStudentsToStorage() {
      localStorage.setItem('smartattend_students', JSON.stringify(studentsDatabase));
    }

    function loadStudentsFromStorage() {
      const stored = localStorage.getItem('smartattend_students');
      if (stored) {
        studentsDatabase = JSON.parse(stored);
      }
    }

    // Update UI
    function updateUI() {
      // Update student list
      const listDiv = document.getElementById('studentList');
      if (studentsDatabase.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No students registered yet.</p>';
      } else {
        listDiv.innerHTML = studentsDatabase.map(student => `
          <div class="student-card">
            <img src="${student.photo}" class="student-photo" alt="${student.name}">
            <div class="student-info">
              <div class="student-name">${student.name}</div>
              <div class="student-roll">${student.roll}</div>
            </div>
            <div class="student-actions">
              <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteStudent('${student.id}')">Delete</button>
            </div>
          </div>
        `).join('');
      }
      
      updateStats();
    }

    function updateStats() {
      document.getElementById('totalStudents').textContent = studentsDatabase.length;
      document.getElementById('presentCount').textContent = todayAttendance.size;
    }

    // Show status message
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
      setTimeout(() => {
        status.style.display = 'none';
      }, 5000);
    }

    function logout() {
      if (confirm('Logout?')) {
        stopCamera();
        window.location.href = 'login.html';
      }
    }

    // Initialize on load
    window.addEventListener('load', init);
  </script>
</body>
</html>